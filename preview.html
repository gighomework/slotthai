<!DOCTYPE html>
<html lang="en">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NS2RG4GS2T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NS2RG4GS2T');
</script>
 <meta http-equiv="content-type" content="text/html;charset=utf-8">   
   <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
<script>
  // VConsole will be exported to `window.VConsole` by default.
  var vConsole = new window.VConsole();
</script>
    <script charset="utf-8" src="js/sdk.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ben sin</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="icon" type="image/png" href="imgfavicon.png">
</head>

<body>
    <div class="container mt-3">
        <form class="form-group">
            <input name="sharedUrl" type="url" id="sharedUrl" class="searchField form-control" />
        </form>
        <!-- ACTION BUTTONS -->
        <center>
            <button id="getPreviewButton" class="btn btn-primary">Get Preview</button>
            <button id="shareTargetPicker" class="btn btn-primary">Open Share Target Picker</button>
            <button id="liffLoginButton" class="btn btn-success">LINE Login</button>
        </center>
        </div>
        <div id="shareTargetPickerMessage"></div>
        <!-- PROFILE INFO -->
        <div id="previewInfo" class="container" style="display: none;">
            <div id="previewPictureDiv" class="card">
                <img id="image" src="" class="card-img-top" alt="Load image failed">
                <div class="card-body">
                    <h5 id="title" class="card-title"></h5>
                    <p id="description" class="card-text"></p>
                </div>
            </div>
        </div>
        </div>
        <div id="statusMessage">
            <div id="isInClientMessage"></div>
        </div>
    </div>
    <script>
        window.onload = function () {
    const defaultLiffId = "1656907941-LJw00vr3";
    initializeLiffOrDie(defaultLiffId);

};

var _title = "";
var _description = "";
var _image = "";
var _url = "";
var _aspectRatio = "20:13"

/**
* Check if myLiffId is null. If null do not initiate liff.
* @param {string} myLiffId The LIFF ID of the selected element
*/
function initializeLiffOrDie(myLiffId) {
    if (!myLiffId) {
    } else {
        initializeLiff(myLiffId);
    }
}

/**
* Initialize LIFF
* @param {string} myLiffId The LIFF ID of the selected element
*/
function initializeLiff(myLiffId) {
    liff
        .init({
            liffId: myLiffId
        })
        .then(() => {
            // start to use LIFF's api
            initializeApp();
        })
        .catch((err) => {
        });
}

function previewUrlInfo(url, isAutoSend = false) {
        // handle facebook no preview issue
        var oldUrl = new URL(url);
	if (oldUrl.hostname.includes('facebook')) {
            oldUrl.hostname = 'mobile.facebook.com';
        }
        console.log('url:' + oldUrl.href);
        fetch('/parse',
            {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ url: oldUrl.href }),
            })
        .then(function(reqResponse) {
            return reqResponse.json();
        })
        .then(function(jsonResponse) {
            _title = jsonResponse.title;
            _description = jsonResponse.description;
            _image = jsonResponse.image;
            _url = url;

            document.getElementById('title').textContent = _title;
            document.getElementById('description').textContent = _description;

            const previewPictureDiv = document.getElementById('previewPictureDiv');
            
            if (!_image) {
                const bold = document.createElement('b');
                bold.innerText = 'No Image!';
                previewPictureDiv.appendChild(bold);
                if (isAutoSend) {
                    setTimeout(function () { sendFlexMessage(); }, 300);
                }
            } else {
                _image = _image.replace('http://', 'https://');
                const img = document.getElementById('image');
                //const img = document.createElement('img');
                img.classList.add("card-img-top");
                img.onload = function () {
                    console.log(this.width + 'x' + this.height);
                    _aspectRatio = this.width + ":" + this.height;
                    // send the message after image is fetched.
                    if (isAutoSend) {
                        setTimeout(function () { sendFlexMessage(); }, 300);
                    }
                }
                img.src = _image;
                img.alt = 'Preview Picture';
                //previewPictureDiv.appendChild(img);
            }

            togglePreviewData();
            document.getElementById('previewInfo').style.display = 'block';
        })
        .catch(function(error) {
            console.log('parse API error' + error);
        });

}

/**
 * Initialize the app by calling functions handling individual app components
 */
function initializeApp() {
    // scenario: the shared url is brought from url path
    // by pass '?url='
    var urlParam = "";
    if (window.location.search.startsWith('?url=')) {
        urlParam = window.location.search.substring(5);
    }
    if(urlParam != "") {
        console.log(urlParam);
        gtag('event','external', {'url': urlParam});

        document.getElementById("sharedUrl").value = urlParam;
        previewUrlInfo(urlParam, true);
    }

    registerButtonHandlers();

    // check if the user is logged in/out, and disable inappropriate button
    if (liff.isLoggedIn()) {
        toggleElement("liffLoginButton");
    }
}

/**
* Register event handlers for the buttons displayed in the app
*/
function registerButtonHandlers() {
    // get preview 
    document.getElementById('getPreviewButton').addEventListener('click', function() {
                var url = document.getElementById("sharedUrl").value;
                gtag('event','internal', {'url': url});
                previewUrlInfo(url);
    });

    document.getElementById('shareTargetPicker').addEventListener('click', function () {
        sendFlexMessage();
    });

    // login call, only when external browser is used
    document.getElementById('liffLoginButton').addEventListener('click', function() {
        if (!liff.isLoggedIn()) {
            document.getElementById('getPreviewButton').style.display = "block";
            document.getElementById('liffLoginButton').style.display = "block";
            liff.login();
        }else{
             document.getElementById('liffLoginButton').style.display = "block";
      }
    });
}

function sendFlexMessage() {
    if (!_title && !_description && !_image) return;

    liff.shareTargetPicker([
        createFlexMessageData(_title, _description, _image, _url, _aspectRatio)
    ]
    ).then(function (res) {
        liff.closeWindow();
    }).catch(function (res) {
        document.getElementById('shareTargetPickerMessage').textContent = "Sending Failed:" + JSON.stringify(res);
    });
}

function createFlexMessageData(title, description, image, url, aspectRatio) {
    var myFlexContent = {
        "type": "bubble",
        "size": "kilo",
        "body": {
          "type": "box",
          "layout": "vertical",
          "action": {
            "type": "uri",
            "label": "前往",
            "uri": url,
          },
          "contents": []
        }
      };

    if (_image) {
        myFlexContent.hero = {
            "type": "image",
            "url": image,
            "size": "full",
            "aspectRatio": aspectRatio,
            "aspectMode": "cover",
            "action": {
                "type": "uri",
                "uri": url
            }
        };
    }
    if (_title) {
        myFlexContent.body.contents.push({
            "type": "text",
            "text": title,
            "weight": "bold",
            "size": "md",
            "wrap": true,
            "maxLines": 3
        });
    }

    if (_description) {
        myFlexContent.body.contents.push({
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "spacing": "sm",
            "contents": [
                {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                        {
                            "type": "text",
                            "text": description,
                            "wrap": true,
                            "color": "#666666",
                            "size": "xxs",
                            "flex": 5,
                            "maxLines": 7
                        }
                    ]
                }
            ]
        });
    }

    var flex = {
        "type": "flex",
        "altText": _title,
        "contents": myFlexContent,
      };

    return flex;
}

function togglePreviewData() {
    toggleElement('previewInfo');
}

/**
* Toggle specified element
* @param {string} elementId The ID of the selected element
*/
function toggleElement(elementId) {
    const elem = document.getElementById(elementId);
    if (elem.offsetWidth > 0 && elem.offsetHeight > 0) {
        elem.style.display = 'none';
    } else {
        elem.style.display = 'block';
    }
}

    </script>
</body>
</html>
